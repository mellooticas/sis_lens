<!--
  üè† Dashboard - Design Vitrificado
  Dashboard principal com estat√≠sticas e an√°lises
-->
<script lang="ts">
  import type { PageData } from "./$types";
  import GlassLayout from "$lib/components/layout/GlassLayout.svelte";
  import GlassCard from "$lib/components/ui/GlassCard.svelte";
  import GlassPanel from "$lib/components/ui/GlassPanel.svelte";
  import { goto } from "$app/navigation";

  export let data: PageData;

  // Dados computados
  $: estatisticas = data.estatisticas || {};
  $: decisoesRecentes = data.decisoes_recentes || [];
  $: topLentes = data.top_lentes || [];

  // Mock data para demonstra√ß√£o
  const stats = {
    totalBalance: 789999.56,
    earnings: 958999.56,
    expenses: 39999.67,
    decisoesToday: 42,
    economyMonth: 12450.00
  };

  const recentActivities = [
    { 
      type: 'decision', 
      title: 'Varilux X 1.67 AR', 
      lab: 'Essilor', 
      time: 'H√° 5 min',
      value: 342.00,
      saved: 28.00
    },
    { 
      type: 'decision', 
      title: 'Transitions XTRActive', 
      lab: 'Zeiss', 
      time: 'H√° 12 min',
      value: 589.00,
      saved: 45.00
    },
    { 
      type: 'alert', 
      title: 'Prazo Hoya atualizado', 
      time: 'H√° 1h',
      message: 'Redu√ß√£o de 2 dias no prazo'
    },
  ];

  function formatCurrency(value: number): string {
    return value.toLocaleString('pt-BR', {
      style: 'currency',
      currency: 'BRL',
    });
  }
</script>

<GlassLayout 
  currentPage="/dashboard" 
  pageTitle="Dashboard"
  pageSubtitle="Vis√£o geral do sistema decisor de lentes"
>
  <!-- Stats Grid -->
  <div class="stats-grid">
    <GlassPanel 
      title="Saldo Total"
      value={formatCurrency(stats.totalBalance)}
      icon="üí∞"
      trend="up"
      trendValue="+12.5%"
      variant="default"
      size="md"
    />
    
    <GlassPanel 
      title="Economia Mensal"
      value={formatCurrency(stats.economyMonth)}
      icon="üìà"
      trend="up"
      trendValue="+8.2%"
      variant="success"
      size="md"
    />
    
    <GlassPanel 
      title="Decis√µes Hoje"
      value={stats.decisoesToday}
      subtitle="Lentes processadas"
      icon="üéØ"
      trend="neutral"
      variant="primary"
      size="md"
    />

    <GlassPanel 
      title="Melhor Margem"
      value="42%"
      subtitle="M√©dia do m√™s"
      icon="üìä"
      trend="up"
      trendValue="+3.1%"
      variant="gradient"
      size="md"
    />
  </div>

  <!-- Chart Section -->
  <div class="chart-section">
    <GlassCard variant="dark" blur="lg" padding="lg">
      <div class="section-header">
        <div>
          <h3 class="section-title">An√°lise de Decis√µes</h3>
          <p class="section-subtitle">Hist√≥rico dos √∫ltimos 6 meses</p>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-dot green"></span>
            <span>Economia</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot orange"></span>
            <span>Volume</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot blue"></span>
            <span>Margem</span>
          </div>
        </div>
      </div>
      
      <div class="chart-container">
        <svg viewBox="0 0 600 250" class="line-chart">
          <!-- Grid -->
          <line x1="0" y1="50" x2="600" y2="50" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
          <line x1="0" y1="100" x2="600" y2="100" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
          <line x1="0" y1="150" x2="600" y2="150" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
          <line x1="0" y1="200" x2="600" y2="200" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
          
          <!-- Lines -->
          <path 
            d="M 0 180 L 100 140 L 200 120 L 300 100 L 400 90 L 500 80 L 600 70" 
            stroke="#22c55e" 
            stroke-width="3" 
            fill="none"
            stroke-linecap="round"
          />
          <path 
            d="M 0 150 L 100 160 L 200 130 L 300 125 L 400 120 L 500 110 L 600 100" 
            stroke="#f59e0b" 
            stroke-width="3" 
            fill="none"
            stroke-linecap="round"
          />
          <path 
            d="M 0 170 L 100 180 L 200 160 L 300 150 L 400 140 L 500 130 L 600 120" 
            stroke="#3b82f6" 
            stroke-width="3" 
            fill="none"
            stroke-linecap="round"
          />
          
          <!-- Highlight point -->
          <circle cx="300" cy="100" r="6" fill="white" stroke="#22c55e" stroke-width="3"/>
          <text x="300" y="85" fill="white" font-size="14" text-anchor="middle" font-weight="600">
            R$ 12,4k
          </text>
        </svg>
        
        <div class="chart-labels">
          <span>Jan</span>
          <span>Fev</span>
          <span>Mar</span>
          <span>Abr</span>
          <span>Mai</span>
          <span>Jun</span>
        </div>
      </div>
    </GlassCard>
  </div>

  <!-- Bottom Grid -->
  <div class="bottom-grid">
    <!-- Recent Activity -->
    <GlassCard variant="dark" blur="lg" padding="lg">
      <div class="section-header">
        <h3 class="section-title">Atividade Recente</h3>
        <button class="view-all-btn" on:click={() => goto('/historico')}>
          Ver todas ‚Üí
        </button>
      </div>
      
      <div class="activity-list">
        {#each recentActivities as activity}
          <div class="activity-item">
            <div class="activity-icon {activity.type}">
              {activity.type === 'decision' ? 'üéØ' : '‚ö°'}
            </div>
            <div class="activity-info">
              <div class="activity-title">{activity.title}</div>
              {#if activity.lab}
                <div class="activity-meta">
                  <span class="lab-name">{activity.lab}</span>
                  {#if activity.saved}
                    <span class="saved-badge">Economizou {formatCurrency(activity.saved)}</span>
                  {/if}
                </div>
              {:else if activity.message}
                <div class="activity-message">{activity.message}</div>
              {/if}
            </div>
            <div class="activity-time">{activity.time}</div>
            {#if activity.value}
              <div class="activity-value">{formatCurrency(activity.value)}</div>
            {/if}
          </div>
        {/each}
      </div>
    </GlassCard>

    <!-- Top Lentes -->
    <GlassCard variant="dark" blur="lg" padding="lg">
      <div class="section-header">
        <h3 class="section-title">Top Lentes do M√™s</h3>
        <button class="view-all-btn" on:click={() => goto('/ranking')}>
          Ver ranking ‚Üí
        </button>
      </div>
      
      <div class="top-lenses">
        <div class="lens-item featured">
          <div class="lens-rank">ü•á</div>
          <div class="lens-info">
            <div class="lens-name">Varilux X Series 1.67</div>
            <div class="lens-stats">
              <span class="stat">142 decis√µes</span>
              <span class="stat">R$ 48,5k economia</span>
            </div>
          </div>
          <div class="lens-badge best">Melhor</div>
        </div>

        <div class="lens-item">
          <div class="lens-rank">ü•à</div>
          <div class="lens-info">
            <div class="lens-name">Transitions XTRActive</div>
            <div class="lens-stats">
              <span class="stat">98 decis√µes</span>
              <span class="stat">R$ 32,1k economia</span>
            </div>
          </div>
        </div>

        <div class="lens-item">
          <div class="lens-rank">ü•â</div>
          <div class="lens-info">
            <div class="lens-name">Crizal Sapphire UV</div>
            <div class="lens-stats">
              <span class="stat">76 decis√µes</span>
              <span class="stat">R$ 21,8k economia</span>
            </div>
          </div>
        </div>
      </div>
    </GlassCard>

    <!-- Quick Actions -->
    <GlassCard variant="dark" blur="lg" padding="lg">
      <h3 class="section-title">A√ß√µes R√°pidas</h3>
      
      <div class="quick-actions">
        <button class="action-btn primary" on:click={() => goto('/buscar')}>
          <span class="action-icon">üîç</span>
          <div class="action-text">
            <div class="action-title">Buscar Lente</div>
            <div class="action-desc">Nova busca</div>
          </div>
        </button>

        <button class="action-btn secondary" on:click={() => goto('/comparar')}>
          <span class="action-icon">‚öñÔ∏è</span>
          <div class="action-text">
            <div class="action-title">Comparar</div>
            <div class="action-desc">An√°lise detalhada</div>
          </div>
        </button>

        <button class="action-btn tertiary" on:click={() => goto('/catalogo')}>
          <span class="action-icon">üì¶</span>
          <div class="action-text">
            <div class="action-title">Cat√°logo</div>
            <div class="action-desc">Ver produtos</div>
          </div>
        </button>

        <button class="action-btn quaternary" on:click={() => goto('/analytics')}>
          <span class="action-icon">üìä</span>
          <div class="action-text">
            <div class="action-title">Relat√≥rios</div>
            <div class="action-desc">Analytics</div>
          </div>
        </button>
      </div>
    </GlassCard>
  </div>
</GlassLayout>

<style>
  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Chart Section */
  .chart-section {
    margin-bottom: 1.5rem;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin: 0 0 0.25rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .section-subtitle {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
    margin: 0;
  }

  .chart-legend {
    display: flex;
    gap: 1.5rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .legend-dot.green { background: #22c55e; }
  .legend-dot.orange { background: #f59e0b; }
  .legend-dot.blue { background: #3b82f6; }

  .chart-container {
    margin-top: 2rem;
  }

  .line-chart {
    width: 100%;
    height: auto;
  }

  .chart-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }

  /* Bottom Grid */
  .bottom-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .view-all-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
  }

  .view-all-btn:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  /* Activity List */
  .activity-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .activity-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .activity-item:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .activity-icon {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: rgba(255, 255, 255, 0.1);
  }

  .activity-icon.decision {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));
  }

  .activity-icon.alert {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.3));
  }

  .activity-info {
    flex: 1;
  }

  .activity-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.25rem;
  }

  .activity-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    font-size: 0.75rem;
  }

  .lab-name {
    color: rgba(255, 255, 255, 0.6);
  }

  .saved-badge {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-weight: 600;
  }

  .activity-message {
    font-size: 0.8125rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .activity-time {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
  }

  .activity-value {
    font-size: 1rem;
    font-weight: 700;
    color: white;
    font-family: 'Courier New', monospace;
  }

  /* Top Lenses */
  .top-lenses {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .lens-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0.75rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }

  .lens-item:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateX(4px);
  }

  .lens-item.featured {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2));
    border-color: rgba(245, 158, 11, 0.4);
  }

  .lens-rank {
    font-size: 1.75rem;
  }

  .lens-info {
    flex: 1;
  }

  .lens-name {
    font-size: 0.9375rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.5rem;
  }

  .lens-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .lens-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .lens-badge.best {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    color: #78350f;
  }

  /* Quick Actions */
  .quick-actions {
    display: grid;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
  }

  .action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    transform: translateX(4px);
  }

  .action-icon {
    font-size: 2rem;
    width: 52px;
    height: 52px;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
  }

  .action-btn.primary .action-icon {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3));
  }

  .action-btn.secondary .action-icon {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(217, 119, 6, 0.3));
  }

  .action-btn.tertiary .action-icon {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3));
  }

  .action-btn.quaternary .action-icon {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.3));
  }

  .action-text {
    flex: 1;
  }

  .action-title {
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
  }

  .action-desc {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .bottom-grid {
      grid-template-columns: 1fr;
    }

    .chart-legend {
      flex-direction: column;
      gap: 0.75rem;
    }
  }
</style>
