-- ============================================================================
-- DIAGNÓSTICO: Schema PUBLIC após limpeza do SIS_LENS
-- ============================================================================
-- Objetivo: Identificar views/funções quebradas ou desnecessárias no schema public
-- Data: 20/01/2026
-- ============================================================================

-- ============================================================================
-- ETAPA 1: LISTAR TODAS AS VIEWS NO SCHEMA PUBLIC
-- ============================================================================
SELECT 
  table_name as view_name,
  view_definition as definicao
FROM information_schema.views
WHERE table_schema = 'public'
ORDER BY table_name;

| view_name                    | definicao                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| v_filtros_disponiveis        |  SELECT 'tipo_lente'::text AS filtro_nome,
    (lentes.tipo_lente)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.tipo_lente
UNION ALL
 SELECT 'material'::text AS filtro_nome,
    (lentes.material)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.material
UNION ALL
 SELECT 'indice_refracao'::text AS filtro_nome,
    (lentes.indice_refracao)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.indice_refracao
UNION ALL
 SELECT 'categoria'::text AS filtro_nome,
    (lentes.categoria)::text AS valor,
    count(*) AS total,
    min(lentes.preco_venda_sugerido) AS preco_min,
    max(lentes.preco_venda_sugerido) AS preco_max
   FROM lens_catalog.lentes
  WHERE ((lentes.ativo = true) AND (lentes.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY lentes.categoria
UNION ALL
 SELECT 'marca'::text AS filtro_nome,
    m.nome AS valor,
    count(*) AS total,
    min(l.preco_venda_sugerido) AS preco_min,
    max(l.preco_venda_sugerido) AS preco_max
   FROM (lens_catalog.lentes l
     JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY m.nome
UNION ALL
 SELECT 'fornecedor'::text AS filtro_nome,
    f.nome AS valor,
    count(*) AS total,
    min(l.preco_venda_sugerido) AS preco_min,
    max(l.preco_venda_sugerido) AS preco_max
   FROM (lens_catalog.lentes l
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente))
  GROUP BY f.nome
  ORDER BY 1, 3 DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_filtros_grupos_canonicos   |  SELECT filtro_categoria,
    filtro_valor,
    count(*) AS total_grupos,
    min(preco_minimo) AS preco_min,
    max(preco_maximo) AS preco_max,
    (avg(preco_medio))::numeric(10,2) AS preco_medio_geral,
    sum(total_lentes) AS total_lentes_agregado
   FROM ( SELECT 'tipo_lente'::text AS filtro_categoria,
            (grupos_canonicos.tipo_lente)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'material'::text AS filtro_categoria,
            (grupos_canonicos.material)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'indice_refracao'::text AS filtro_categoria,
            (grupos_canonicos.indice_refracao)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'categoria'::text AS filtro_categoria,
            (grupos_canonicos.categoria_predominante)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'is_premium'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.is_premium THEN 'premium'::text
                    ELSE 'generico'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'antirreflexo'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.tem_antirreflexo THEN 'sim'::text
                    ELSE 'nao'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'blue_light'::text AS filtro_categoria,
                CASE
                    WHEN grupos_canonicos.tem_blue_light THEN 'sim'::text
                    ELSE 'nao'::text
                END AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.total_lentes > 0)
        UNION ALL
         SELECT 'fotossensiveis'::text AS filtro_categoria,
            (grupos_canonicos.tratamento_foto)::text AS filtro_valor,
            grupos_canonicos.preco_minimo,
            grupos_canonicos.preco_maximo,
            grupos_canonicos.preco_medio,
            grupos_canonicos.total_lentes
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.total_lentes > 0) AND (grupos_canonicos.tratamento_foto IS NOT NULL) AND ((grupos_canonicos.tratamento_foto)::text <> 'nenhum'::text))) filtros_agregados
  GROUP BY filtro_categoria, filtro_valor
  ORDER BY filtro_categoria, (count(*)) DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| v_fornecedores_catalogo      |  SELECT id,
    nome,
    razao_social,
    prazo_visao_simples,
    prazo_multifocal,
    prazo_surfacada,
    prazo_free_form,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS total_lentes,
    ( SELECT count(DISTINCT lentes.marca_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS total_marcas,
    ( SELECT min(lentes.preco_venda_sugerido) AS min
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_minimo,
    ( SELECT max(lentes.preco_venda_sugerido) AS max
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_maximo,
    ( SELECT avg(lentes.preco_venda_sugerido) AS avg
           FROM lens_catalog.lentes
          WHERE ((lentes.fornecedor_id = f.id) AND (lentes.ativo = true))) AS preco_medio,
    ((frete_config -> 'contato'::text) ->> 'email'::text) AS email_contato,
    ((frete_config -> 'contato'::text) ->> 'telefone'::text) AS telefone_contato,
    jsonb_build_object('tipo', (frete_config ->> 'tipo'::text), 'frete_gratis_acima', (frete_config ->> 'frete_gratis_acima'::text), 'taxa_fixa', (frete_config ->> 'taxa_fixa'::text)) AS config_frete,
        CASE
            WHEN (prazo_visao_simples <= 3) THEN 'express'::text
            WHEN (prazo_visao_simples <= 7) THEN 'normal'::text
            ELSE 'economico'::text
        END AS badge_prazo,
    ativo,
    created_at
   FROM core.fornecedores f
  WHERE ((ativo = true) AND (deleted_at IS NULL))
  ORDER BY prazo_visao_simples, nome;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| v_fornecedores_por_lente     |  SELECT l.id AS lente_id,
    l.nome_lente AS lente_nome,
    l.slug AS lente_slug,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    f.id AS fornecedor_id,
    f.nome AS fornecedor_nome,
    f.razao_social AS fornecedor_razao_social,
    f.cnpj,
    l.preco_custo,
    COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END) AS prazo_entrega_dias,
    m.nome AS marca_nome,
    m.is_premium AS marca_premium,
    l.ativo AS lente_ativa,
    f.ativo AS fornecedor_ativo,
    row_number() OVER (PARTITION BY l.id ORDER BY COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END), l.preco_custo) AS ranking_fornecedor
   FROM ((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
     LEFT JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
  WHERE ((l.ativo = true) AND (f.ativo = true))
  ORDER BY l.nome_lente, COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| v_grupos_canonicos           |  SELECT id,
    slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    categoria_predominante,
    grau_esferico_min,
    grau_esferico_max,
    grau_cilindrico_min,
    grau_cilindrico_max,
    adicao_min,
    adicao_max,
    descricao_ranges,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_maximo,
    preco_medio,
    total_lentes,
    total_marcas,
    peso,
    is_premium
   FROM lens_catalog.grupos_canonicos gc
  WHERE ((ativo = true) AND (is_premium = false))
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| v_grupos_canonicos_completos |  SELECT id,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    preco_medio,
    ( SELECT jsonb_agg(jsonb_build_object('id', l.id, 'nome', f.nome, 'prazo_visao_simples', COALESCE(f.prazo_visao_simples, 0), 'prazo_multifocal', COALESCE(f.prazo_multifocal, 2))) AS jsonb_agg
           FROM (lens_catalog.lentes l
             JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
          WHERE (l.grupo_canonico_id = gc.id)) AS fornecedores_disponiveis,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes l
          WHERE (l.grupo_canonico_id = gc.id)) AS total_lentes,
    false AS is_premium
   FROM lens_catalog.grupos_canonicos gc;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| v_grupos_melhor_margem       |  WITH margem_calculada AS (
         SELECT gc.id AS grupo_id,
            gc.slug AS grupo_slug,
            gc.nome_grupo,
            gc.tipo_lente,
            gc.material,
            gc.indice_refracao,
            gc.tratamento_antirreflexo,
            gc.tratamento_antirrisco,
            gc.tratamento_uv,
            gc.tratamento_blue_light,
            gc.tratamento_fotossensiveis,
            gc.preco_minimo,
            gc.preco_medio,
            gc.preco_maximo,
            avg(l.preco_custo) AS custo_medio,
            min(l.preco_custo) AS custo_minimo,
            max(l.preco_custo) AS custo_maximo,
                CASE
                    WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((((gc.preco_medio - avg(l.preco_custo)) / avg(l.preco_custo)) * (100)::numeric))::numeric(8,2)
                    ELSE (0)::numeric
                END AS margem_percentual,
            ((gc.preco_medio - avg(l.preco_custo)))::numeric(10,2) AS lucro_unitario,
                CASE
                    WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((gc.preco_medio / avg(l.preco_custo)))::numeric(6,2)
                    ELSE NULL::numeric
                END AS markup,
            gc.total_lentes,
            gc.is_premium,
            count(DISTINCT l.marca_id) AS total_marcas,
            count(DISTINCT l.fornecedor_id) AS total_fornecedores
           FROM (lens_catalog.grupos_canonicos gc
             JOIN lens_catalog.lentes l ON (((l.grupo_canonico_id = gc.id) AND (l.ativo = true))))
          GROUP BY gc.id, gc.slug, gc.nome_grupo, gc.tipo_lente, gc.material, gc.indice_refracao, gc.tratamento_antirreflexo, gc.tratamento_antirrisco, gc.tratamento_uv, gc.tratamento_blue_light, gc.tratamento_fotossensiveis, gc.preco_minimo, gc.preco_medio, gc.preco_maximo, gc.total_lentes, gc.is_premium
        )
 SELECT grupo_id,
    grupo_slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_medio,
    preco_maximo,
    custo_medio,
    custo_minimo,
    custo_maximo,
    margem_percentual,
    lucro_unitario,
    markup,
    total_lentes,
    is_premium,
    total_marcas,
    total_fornecedores,
    row_number() OVER (ORDER BY margem_percentual DESC) AS ranking_margem,
    row_number() OVER (PARTITION BY tipo_lente ORDER BY margem_percentual DESC) AS ranking_por_tipo,
        CASE
            WHEN (margem_percentual >= (400)::numeric) THEN 'Excelente'::text
            WHEN (margem_percentual >= (350)::numeric) THEN 'Ótima'::text
            WHEN (margem_percentual >= (300)::numeric) THEN 'Boa'::text
            ELSE 'Regular'::text
        END AS classificacao_margem,
        CASE
            WHEN (markup >= 4.0) THEN true
            ELSE false
        END AS acima_markup_padrao
   FROM margem_calculada
  ORDER BY margem_percentual DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| v_grupos_por_faixa_preco     |  SELECT id AS grupo_id,
    slug AS grupo_slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_medio,
    preco_maximo,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN '< R$150'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'R$150-300'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'R$300-500'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'R$500-800'::text
            ELSE 'R$800+'::text
        END AS faixa_preco,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 1
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 2
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 3
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 4
            ELSE 5
        END AS faixa_ordem,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 'R$150-300'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'R$300-500'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'R$500-800'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'R$800+'::text
            ELSE NULL::text
        END AS proxima_faixa,
        CASE
            WHEN (preco_medio < (150)::numeric) THEN 'Entrada'::text
            WHEN ((preco_medio >= (150)::numeric) AND (preco_medio < (300)::numeric)) THEN 'Básico'::text
            WHEN ((preco_medio >= (300)::numeric) AND (preco_medio < (500)::numeric)) THEN 'Intermediário'::text
            WHEN ((preco_medio >= (500)::numeric) AND (preco_medio < (800)::numeric)) THEN 'Premium'::text
            ELSE 'Super Premium'::text
        END AS descricao_faixa,
    total_lentes,
    is_premium,
    ( SELECT count(DISTINCT lentes.marca_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.grupo_canonico_id = gc.id) AND (lentes.ativo = true))) AS total_marcas,
    ( SELECT count(DISTINCT lentes.fornecedor_id) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.grupo_canonico_id = gc.id) AND (lentes.ativo = true))) AS total_fornecedores
   FROM lens_catalog.grupos_canonicos gc
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| v_grupos_por_receita_cliente |  SELECT gc.id AS grupo_id,
    gc.slug AS grupo_slug,
    gc.nome_grupo,
    gc.tipo_lente,
    gc.material,
    gc.indice_refracao,
    min(l.grau_esferico_min) AS grau_esferico_min,
    max(l.grau_esferico_max) AS grau_esferico_max,
    min(l.grau_cilindrico_min) AS grau_cilindrico_min,
    max(l.grau_cilindrico_max) AS grau_cilindrico_max,
    min(l.adicao_min) AS adicao_min,
    max(l.adicao_max) AS adicao_max,
    gc.tratamento_antirreflexo,
    gc.tratamento_antirrisco,
    gc.tratamento_uv,
    gc.tratamento_blue_light,
    gc.tratamento_fotossensiveis,
    gc.preco_minimo,
    gc.preco_medio,
    gc.preco_maximo,
    avg(l.preco_custo) AS custo_medio,
        CASE
            WHEN (avg(l.preco_custo) > (0)::numeric) THEN ((gc.preco_medio / avg(l.preco_custo)))::numeric(5,2)
            ELSE NULL::numeric
        END AS margem_media,
        CASE
            WHEN (gc.preco_medio < (150)::numeric) THEN 'economica'::text
            WHEN ((gc.preco_medio >= (150)::numeric) AND (gc.preco_medio <= (400)::numeric)) THEN 'intermediaria'::text
            ELSE 'premium'::text
        END AS categoria_sugerida,
    gc.total_lentes,
    count(DISTINCT l.fornecedor_id) AS total_fornecedores,
    count(DISTINCT l.marca_id) AS total_marcas,
    gc.is_premium,
    (avg(
        CASE gc.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_visao_simples, 7)
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            WHEN 'leitura'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_visao_simples, 7)
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN COALESCE(f.prazo_multifocal, 10)
            ELSE 10
        END))::integer AS prazo_medio_dias
   FROM ((lens_catalog.grupos_canonicos gc
     JOIN lens_catalog.lentes l ON (((l.grupo_canonico_id = gc.id) AND (l.ativo = true))))
     LEFT JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
  GROUP BY gc.id, gc.slug, gc.nome_grupo, gc.tipo_lente, gc.material, gc.indice_refracao, gc.tratamento_antirreflexo, gc.tratamento_antirrisco, gc.tratamento_uv, gc.tratamento_blue_light, gc.tratamento_fotossensiveis, gc.preco_minimo, gc.preco_medio, gc.preco_maximo, gc.total_lentes, gc.is_premium
  ORDER BY gc.preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| v_grupos_premium             |  SELECT id,
    slug,
    nome_grupo,
    tipo_lente,
    material,
    indice_refracao,
    categoria_predominante,
    grau_esferico_min,
    grau_esferico_max,
    grau_cilindrico_min,
    grau_cilindrico_max,
    adicao_min,
    adicao_max,
    descricao_ranges,
    tratamento_antirreflexo,
    tratamento_antirrisco,
    tratamento_uv,
    tratamento_blue_light,
    tratamento_fotossensiveis,
    preco_minimo,
    preco_maximo,
    preco_medio,
    total_lentes,
    total_marcas,
    peso,
    is_premium,
    COALESCE(( SELECT jsonb_agg(DISTINCT jsonb_build_object('marca_id', m.id, 'marca_nome', m.nome, 'marca_slug', m.slug, 'is_premium', m.is_premium)) AS jsonb_agg
           FROM (lens_catalog.lentes l
             JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true) AND (m.ativo = true))), '[]'::jsonb) AS marcas_disponiveis,
    COALESCE(( SELECT string_agg(DISTINCT (m.nome)::text, ', '::text ORDER BY (m.nome)::text) AS string_agg
           FROM (lens_catalog.lentes l
             JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
          WHERE ((l.grupo_canonico_id = gc.id) AND (l.ativo = true) AND (m.ativo = true))), ''::text) AS marcas_nomes
   FROM lens_catalog.grupos_canonicos gc
  WHERE ((ativo = true) AND (is_premium = true))
  ORDER BY preco_medio;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| v_lentes_busca               |  SELECT l.id,
    l.slug,
    l.nome_canonizado AS nome,
    f.nome AS fornecedor,
    m.nome AS marca,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    l.categoria,
    l.preco_venda_sugerido AS preco,
    l.tratamento_antirreflexo AS tem_ar,
    l.tratamento_blue_light AS tem_blue,
    l.tratamento_fotossensiveis AS tratamento_foto,
    gc.nome_grupo,
    l.peso,
    ((((((((((l.nome_canonizado || ' '::text) || f.nome) || ' '::text) || (COALESCE(m.nome, ''::character varying))::text) || ' '::text) || (l.tipo_lente)::text) || ' '::text) || (l.material)::text) || ' '::text) || (l.indice_refracao)::text) AS search_text
   FROM (((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((l.fornecedor_id = f.id)))
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
     LEFT JOIN lens_catalog.grupos_canonicos gc ON ((l.grupo_canonico_id = gc.id)))
  WHERE ((l.ativo = true) AND (l.status = 'ativo'::lens_catalog.status_lente) AND (l.deleted_at IS NULL));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| v_lentes_cotacao_compra      |  SELECT l.id AS lente_id,
    l.slug AS lente_slug,
    l.nome_lente AS lente_nome,
    l.nome_canonizado,
    l.tipo_lente,
    l.material,
    l.indice_refracao,
    l.fornecedor_id,
    f.nome AS fornecedor_nome,
    l.marca_id,
    m.nome AS marca_nome,
    l.preco_custo,
    COALESCE(l.lead_time_dias,
        CASE l.tipo_lente
            WHEN 'visao_simples'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'multifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'bifocal'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            WHEN 'leitura'::lens_catalog.tipo_lente THEN f.prazo_visao_simples
            WHEN 'ocupacional'::lens_catalog.tipo_lente THEN f.prazo_multifocal
            ELSE 10
        END) AS prazo_dias,
    l.ativo,
    l.categoria,
    l.grupo_canonico_id
   FROM ((lens_catalog.lentes l
     JOIN core.fornecedores f ON ((f.id = l.fornecedor_id)))
     LEFT JOIN lens_catalog.marcas m ON ((m.id = l.marca_id)))
  WHERE ((l.ativo = true) AND (f.ativo = true))
  ORDER BY l.nome_lente;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| v_sugestoes_upgrade          |  WITH grupos_base AS (
         SELECT gc.id,
            gc.nome_grupo,
            gc.tipo_lente,
            gc.material,
            gc.indice_refracao,
            gc.preco_medio,
            gc.tratamento_antirreflexo,
            gc.tratamento_antirrisco,
            gc.tratamento_uv,
            gc.tratamento_blue_light,
            gc.tratamento_fotossensiveis,
            ((((
                CASE
                    WHEN gc.tratamento_antirreflexo THEN 1
                    ELSE 0
                END +
                CASE
                    WHEN gc.tratamento_antirrisco THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN gc.tratamento_uv THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN gc.tratamento_blue_light THEN 1
                    ELSE 0
                END) +
                CASE
                    WHEN (gc.tratamento_fotossensiveis <> 'nenhum'::text) THEN 1
                    ELSE 0
                END) AS total_tratamentos
           FROM lens_catalog.grupos_canonicos gc
        )
 SELECT gb.id AS grupo_base_id,
    gb.nome_grupo AS grupo_base_nome,
    gb.preco_medio AS preco_base,
    gb.total_tratamentos AS tratamentos_base,
    gu.id AS grupo_upgrade_id,
    gu.nome_grupo AS grupo_upgrade_nome,
    gu.preco_medio AS preco_upgrade,
    gu.total_tratamentos AS tratamentos_upgrade,
    ((gu.preco_medio - gb.preco_medio))::numeric(10,2) AS diferenca_preco,
    ((((gu.preco_medio - gb.preco_medio) / gb.preco_medio) * (100)::numeric))::numeric(5,2) AS diferenca_percentual,
    array_remove(ARRAY[
        CASE
            WHEN (gu.tratamento_antirreflexo AND (NOT gb.tratamento_antirreflexo)) THEN 'Antirreflexo'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_antirrisco AND (NOT gb.tratamento_antirrisco)) THEN 'Antirrisco'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_uv AND (NOT gb.tratamento_uv)) THEN 'Proteção UV'::text
            ELSE NULL::text
        END,
        CASE
            WHEN (gu.tratamento_blue_light AND (NOT gb.tratamento_blue_light)) THEN 'Filtro Luz Azul'::text
            ELSE NULL::text
        END,
        CASE
            WHEN ((gu.tratamento_fotossensiveis <> 'nenhum'::text) AND (gb.tratamento_fotossensiveis = 'nenhum'::text)) THEN (('Fotossensível ('::text || gu.tratamento_fotossensiveis) || ')'::text)
            ELSE NULL::text
        END], NULL::text) AS tratamentos_adicionais,
        CASE
            WHEN (gu.tratamento_blue_light AND (NOT gb.tratamento_blue_light)) THEN 'Proteção contra luz azul de telas + maior conforto visual'::text
            WHEN (gu.tratamento_antirreflexo AND (NOT gb.tratamento_antirreflexo)) THEN 'Visão mais nítida e sem reflexos + estética melhor'::text
            WHEN ((gu.tratamento_fotossensiveis <> 'nenhum'::text) AND (gb.tratamento_fotossensiveis = 'nenhum'::text)) THEN 'Adaptação automática à luminosidade + proteção solar'::text
            ELSE 'Proteção e durabilidade superiores'::text
        END AS beneficios,
    gb.tipo_lente,
    gb.material,
    gb.indice_refracao,
    (gu.total_tratamentos - gb.total_tratamentos) AS tratamentos_extras_count
   FROM (grupos_base gb
     JOIN grupos_base gu ON (((gu.tipo_lente = gb.tipo_lente) AND (gu.material = gb.material) AND (gu.indice_refracao = gb.indice_refracao) AND (gu.total_tratamentos > gb.total_tratamentos) AND (gu.preco_medio > gb.preco_medio) AND (gu.preco_medio <= (gb.preco_medio * (2)::numeric)) AND (gu.id <> gb.id))))
  ORDER BY gb.preco_medio, (((gu.preco_medio - gb.preco_medio))::numeric(10,2));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| vw_bi_lentes_lucratividade   |  SELECT COALESCE(m.nome, 'Indefinido'::character varying) AS marca,
    COALESCE((l.categoria)::text, 'Geral'::text) AS categoria,
    count(*) AS qtd_produtos,
    (avg(l.custo_base))::numeric(10,2) AS custo_medio,
    (avg(l.preco_tabela))::numeric(10,2) AS preco_medio
   FROM (lens_catalog.lentes l
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE (l.custo_base > (0)::numeric)
  GROUP BY m.nome, l.categoria;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| vw_lentes_catalogo           |  SELECT l.id,
    l.marca_id,
    l.fornecedor_id,
    l.grupo_canonico_id,
    l.sku_fornecedor,
    l.codigo_original,
    l.nome_comercial,
    m.nome AS marca_nome,
    m.slug AS marca_slug,
    m.is_premium AS marca_premium,
    l.tipo_lente,
    l.categoria,
    l.material,
    l.indice_refracao,
    l.linha_produto,
    l.diametro,
    l.espessura_central,
    l.peso_aproximado,
    l.esferico_min,
    l.esferico_max,
    l.cilindrico_min,
    l.cilindrico_max,
    l.adicao_min,
    l.adicao_max,
    l.dnp_min,
    l.dnp_max,
    l.ar,
    l.antirrisco,
    l.hidrofobico,
    l."antiembaçante",
    l.blue,
    l.uv400,
    l.fotossensivel,
    l.polarizado,
    l.digital,
    l.free_form,
    l.indoor,
    l.drive,
    l.custo_base,
    l.preco_fabricante,
    l.preco_tabela,
    l.prazo_entrega,
    l.obs_prazo,
    l.peso_frete,
    l.exige_receita_especial,
    l.descricao_curta,
    l.descricao_completa,
    l.beneficios,
    l.indicacoes,
    l.contraindicacoes,
    l.observacoes,
    l.status,
    l.disponivel,
    l.destaque,
    l.novidade,
    l.data_lancamento,
    l.data_descontinuacao,
    l.created_at,
    l.updated_at
   FROM (lens_catalog.lentes l
     LEFT JOIN lens_catalog.marcas m ON ((l.marca_id = m.id)))
  WHERE (l.status = 'ativo'::lens_catalog.status_lente)
  ORDER BY l.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| vw_stats_catalogo            |  SELECT ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS total_lentes,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.grupo_canonico_id IS NOT NULL))) AS lentes_genericas,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'economica'::lens_catalog.categoria_lente))) AS lentes_economicas,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'intermediaria'::lens_catalog.categoria_lente))) AS lentes_intermediarias,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'premium'::lens_catalog.categoria_lente))) AS lentes_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.categoria = 'super_premium'::lens_catalog.categoria_lente))) AS lentes_super_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE (grupos_canonicos.ativo = true)) AS grupos_genericos,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.ativo = true) AND (grupos_canonicos.is_premium = false))) AS grupos_standard,
    ( SELECT count(*) AS count
           FROM lens_catalog.grupos_canonicos
          WHERE ((grupos_canonicos.ativo = true) AND (grupos_canonicos.is_premium = true))) AS grupos_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE (marcas.ativo = true)) AS total_marcas,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE ((marcas.ativo = true) AND (marcas.is_premium = false))) AS marcas_standard,
    ( SELECT count(*) AS count
           FROM lens_catalog.marcas
          WHERE ((marcas.ativo = true) AND (marcas.is_premium = true))) AS marcas_premium,
    ( SELECT count(*) AS count
           FROM core.fornecedores
          WHERE (fornecedores.ativo = true)) AS total_fornecedores,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_antirreflexo = true))) AS total_com_ar,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_blue_light = true))) AS total_com_blue,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis IS NOT NULL) AND (lentes.tratamento_fotossensiveis <> 'nenhum'::lens_catalog.tratamento_foto))) AS total_fotossensiveis,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_uv = true))) AS total_uv400,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_antirrisco = true))) AS total_antirrisco,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'transitions'::lens_catalog.tratamento_foto))) AS total_transitions,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'fotocromático'::lens_catalog.tratamento_foto))) AS total_fotocromatico,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tratamento_fotossensiveis = 'polarizado'::lens_catalog.tratamento_foto))) AS total_polarizado,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'visao_simples'::lens_catalog.tipo_lente))) AS total_visao_simples,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'multifocal'::lens_catalog.tipo_lente))) AS total_multifocal,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'bifocal'::lens_catalog.tipo_lente))) AS total_bifocal,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'leitura'::lens_catalog.tipo_lente))) AS total_leitura,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.tipo_lente = 'ocupacional'::lens_catalog.tipo_lente))) AS total_ocupacional,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'CR39'::lens_catalog.material_lente))) AS total_cr39,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'POLICARBONATO'::lens_catalog.material_lente))) AS total_policarbonato,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'TRIVEX'::lens_catalog.material_lente))) AS total_trivex,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'HIGH_INDEX'::lens_catalog.material_lente))) AS total_high_index,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'VIDRO'::lens_catalog.material_lente))) AS total_vidro,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.material = 'ACRILICO'::lens_catalog.material_lente))) AS total_acrilico,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.50'::lens_catalog.indice_refracao))) AS total_indice_150,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.56'::lens_catalog.indice_refracao))) AS total_indice_156,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.59'::lens_catalog.indice_refracao))) AS total_indice_159,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.61'::lens_catalog.indice_refracao))) AS total_indice_161,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.67'::lens_catalog.indice_refracao))) AS total_indice_167,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.74'::lens_catalog.indice_refracao))) AS total_indice_174,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.indice_refracao = '1.90'::lens_catalog.indice_refracao))) AS total_indice_190,
    ( SELECT min(lentes.preco_venda_sugerido) AS min
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_minimo_catalogo,
    ( SELECT max(lentes.preco_venda_sugerido) AS max
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_maximo_catalogo,
    ( SELECT round(avg(lentes.preco_venda_sugerido), 2) AS round
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_medio_catalogo,
    ( SELECT percentile_cont((0.5)::double precision) WITHIN GROUP (ORDER BY ((lentes.preco_venda_sugerido)::double precision)) AS percentile_cont
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL))) AS preco_mediano_catalogo,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido < (500)::numeric))) AS faixa_economica,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (500)::numeric) AND (lentes.preco_venda_sugerido < (1500)::numeric))) AS faixa_intermediaria,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (1500)::numeric) AND (lentes.preco_venda_sugerido < (3000)::numeric))) AS faixa_premium,
    ( SELECT count(*) AS count
           FROM lens_catalog.lentes
          WHERE ((lentes.ativo = true) AND (lentes.deleted_at IS NULL) AND (lentes.preco_venda_sugerido >= (3000)::numeric))) AS faixa_ultra_premium; |



-- ============================================================================
-- ETAPA 2: IDENTIFICAR VIEWS QUE PODEM ESTAR QUEBRADAS
-- ============================================================================
-- Views que referenciam tabelas removidas:
-- - lens_catalog.lentes_canonicas (REMOVIDA)
-- - lens_catalog.premium_canonicas (REMOVIDA)
-- - compras.* (SCHEMA REMOVIDO)

-- Teste manual de cada view
DO $$
DECLARE
  v_view RECORD;
  v_erro TEXT;
BEGIN
  RAISE NOTICE '========================================';
  RAISE NOTICE '🔍 TESTANDO VIEWS DO SCHEMA PUBLIC';
  RAISE NOTICE '========================================';
  
  FOR v_view IN 
    SELECT table_name 
    FROM information_schema.views 
    WHERE table_schema = 'public'
    ORDER BY table_name
  LOOP
    BEGIN
      -- Tenta fazer um SELECT simples
      EXECUTE format('SELECT COUNT(*) FROM public.%I LIMIT 1', v_view.table_name);
      RAISE NOTICE '✅ View %: OK', v_view.table_name;
    EXCEPTION WHEN OTHERS THEN
      GET STACKED DIAGNOSTICS v_erro = MESSAGE_TEXT;
      RAISE WARNING '❌ View % QUEBRADA: %', v_view.table_name, v_erro;
    END;
  END LOOP;
  
  RAISE NOTICE '========================================';
END $$;

Success. No rows returned





-- ============================================================================
-- ETAPA 3: BUSCAR REFERÊNCIAS A TABELAS REMOVIDAS
-- ============================================================================

-- 3.1 - Views que referenciam lentes_canonicas
SELECT 
  table_name as view_com_problema,
  'Referencia lentes_canonicas (REMOVIDA)' as problema
FROM information_schema.views
WHERE table_schema = 'public'
  AND view_definition ILIKE '%lentes_canonicas%';
Success. No rows returned




-- 3.2 - Views que referenciam premium_canonicas
SELECT 
  table_name as view_com_problema,
  'Referencia premium_canonicas (REMOVIDA)' as problema
FROM information_schema.views
WHERE table_schema = 'public'
  AND view_definition ILIKE '%premium_canonicas%';


Success. No rows returned





-- 3.3 - Views que referenciam schema compras
SELECT 
  table_name as view_com_problema,
  'Referencia schema compras (REMOVIDO)' as problema
FROM information_schema.views
WHERE table_schema = 'public'
  AND view_definition ILIKE '%compras.%';

Success. No rows returned




-- ============================================================================
-- ETAPA 4: LISTAR FUNCTIONS NO SCHEMA PUBLIC
-- ============================================================================
SELECT 
  p.proname as function_name,
  pg_get_function_arguments(p.oid) as parametros,
  pg_get_function_result(p.oid) as retorno,
  CASE 
    WHEN p.provolatile = 'v' THEN 'VOLATILE'
    WHEN p.provolatile = 's' THEN 'STABLE'
    WHEN p.provolatile = 'i' THEN 'IMMUTABLE'
  END as tipo
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.prokind = 'f' -- Functions (não triggers/procedures)
ORDER BY p.proname;

| function_name             | parametros                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | retorno                                                                                                                                                                                                                                                                                                                         | tipo     |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| buscar_lentes             | p_tipo_lente lens_catalog.tipo_lente DEFAULT NULL::lens_catalog.tipo_lente, p_material lens_catalog.material_lente DEFAULT NULL::lens_catalog.material_lente, p_indice lens_catalog.indice_refracao DEFAULT NULL::lens_catalog.indice_refracao, p_preco_min numeric DEFAULT NULL::numeric, p_preco_max numeric DEFAULT NULL::numeric, p_tem_ar boolean DEFAULT NULL::boolean, p_tem_blue boolean DEFAULT NULL::boolean, p_fornecedor_id uuid DEFAULT NULL::uuid, p_marca_id uuid DEFAULT NULL::uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0 | TABLE(id uuid, slug text, nome text, fornecedor text, marca text, tipo_lente lens_catalog.tipo_lente, material lens_catalog.material_lente, indice_refracao lens_catalog.indice_refracao, preco numeric, categoria lens_catalog.categoria_lente, tem_ar boolean, tem_blue boolean, grupo_nome text, estoque_disponivel integer) | STABLE   |
| buscar_lentes_por_receita | p_esferico numeric, p_cilindrico numeric, p_adicao numeric DEFAULT NULL::numeric, p_tipo_lente text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                      | SETOF vw_lentes_catalogo                                                                                                                                                                                                                                                                                                        | VOLATILE |
| obter_alternativas_lente  | p_lente_id uuid, p_limit integer DEFAULT 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | TABLE(id uuid, slug text, nome text, fornecedor text, preco numeric, diferenca_preco numeric, prazo_dias integer)                                                                                                                                                                                                               | STABLE   |
| unaccent                  | text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | text                                                                                                                                                                                                                                                                                                                            | STABLE   |
| unaccent                  | regdictionary, text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | text                                                                                                                                                                                                                                                                                                                            | STABLE   |
| unaccent_init             | internal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | internal                                                                                                                                                                                                                                                                                                                        | VOLATILE |
| unaccent_lexize           | internal, internal, internal, internal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | internal                                                                                                                                                                                                                                                                                                                        | VOLATILE |


-- ============================================================================
-- ETAPA 5: VERIFICAR CÓDIGO DAS FUNCTIONS (buscar referências quebradas)
-- ============================================================================
SELECT 
  p.proname as function_name,
  pg_get_functiondef(p.oid) as codigo_completo
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.prokind = 'f'
  AND (
    pg_get_functiondef(p.oid) ILIKE '%lentes_canonicas%' OR
    pg_get_functiondef(p.oid) ILIKE '%premium_canonicas%' OR
    pg_get_functiondef(p.oid) ILIKE '%compras.%'
  )
ORDER BY p.proname;


| function_name | codigo_completo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| buscar_lentes | CREATE OR REPLACE FUNCTION public.buscar_lentes(p_tipo_lente lens_catalog.tipo_lente DEFAULT NULL::lens_catalog.tipo_lente, p_material lens_catalog.material_lente DEFAULT NULL::lens_catalog.material_lente, p_indice lens_catalog.indice_refracao DEFAULT NULL::lens_catalog.indice_refracao, p_preco_min numeric DEFAULT NULL::numeric, p_preco_max numeric DEFAULT NULL::numeric, p_tem_ar boolean DEFAULT NULL::boolean, p_tem_blue boolean DEFAULT NULL::boolean, p_fornecedor_id uuid DEFAULT NULL::uuid, p_marca_id uuid DEFAULT NULL::uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0)
 RETURNS TABLE(id uuid, slug text, nome text, fornecedor text, marca text, tipo_lente lens_catalog.tipo_lente, material lens_catalog.material_lente, indice_refracao lens_catalog.indice_refracao, preco numeric, categoria lens_catalog.categoria_lente, tem_ar boolean, tem_blue boolean, grupo_nome text, estoque_disponivel integer)
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        l.id,
        l.slug,
        l.nome_canonizado,
        f.nome as fornecedor,
        m.nome as marca,
        l.tipo_lente,
        l.material,
        l.indice_refracao,
        l.preco_venda_sugerido,
        l.categoria,
        l.tratamento_antirreflexo,
        l.tratamento_blue_light,
        gc.nome_grupo,
        COALESCE(es.quantidade_disponivel, 0)::INTEGER
    FROM lens_catalog.lentes l
    JOIN core.fornecedores f ON l.fornecedor_id = f.id
    LEFT JOIN lens_catalog.marcas m ON l.marca_id = m.id
    LEFT JOIN lens_catalog.grupos_canonicos gc ON l.grupo_canonico_id = gc.id
    LEFT JOIN compras.estoque_saldo es ON l.id = es.lente_id
    WHERE l.ativo = true
    AND l.status = 'ativo'
    AND (p_tipo_lente IS NULL OR l.tipo_lente = p_tipo_lente)
    AND (p_material IS NULL OR l.material = p_material)
    AND (p_indice IS NULL OR l.indice_refracao = p_indice)
    AND (p_preco_min IS NULL OR l.preco_venda_sugerido >= p_preco_min)
    AND (p_preco_max IS NULL OR l.preco_venda_sugerido <= p_preco_max)
    AND (p_tem_ar IS NULL OR l.tratamento_antirreflexo = p_tem_ar)
    AND (p_tem_blue IS NULL OR l.tratamento_blue_light = p_tem_blue)
    AND (p_fornecedor_id IS NULL OR l.fornecedor_id = p_fornecedor_id)
    AND (p_marca_id IS NULL OR l.marca_id = p_marca_id)
    ORDER BY l.peso DESC, l.preco_venda_sugerido ASC
    LIMIT p_limit
    OFFSET p_offset;
END;
$function$
 |


-- ============================================================================
-- ETAPA 6: BUSCAR VIEWS QUE DEPENDEM DE OUTRAS VIEWS
-- ============================================================================
-- (para entender dependências antes de remover)

WITH view_dependencies AS (
  SELECT DISTINCT
    v.view_schema,
    v.view_name,
    v.table_schema as dep_schema,
    v.table_name as dep_table
  FROM information_schema.view_table_usage v
  WHERE v.view_schema = 'public'
)
SELECT 
  vd.view_name,
  vd.dep_schema || '.' || vd.dep_table as dependencia,
  CASE 
    WHEN NOT EXISTS (
      SELECT 1 FROM information_schema.tables t
      WHERE t.table_schema = vd.dep_schema 
        AND t.table_name = vd.dep_table
    ) THEN '❌ DEPENDÊNCIA QUEBRADA'
    ELSE '✅ Dependência OK'
  END as status
FROM view_dependencies vd
ORDER BY vd.view_name, vd.dep_schema, vd.dep_table;


| view_name                    | dependencia                   | status           |
| ---------------------------- | ----------------------------- | ---------------- |
| v_filtros_disponiveis        | core.fornecedores             | ✅ Dependência OK |
| v_filtros_disponiveis        | lens_catalog.lentes           | ✅ Dependência OK |
| v_filtros_disponiveis        | lens_catalog.marcas           | ✅ Dependência OK |
| v_filtros_grupos_canonicos   | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_fornecedores_catalogo      | core.fornecedores             | ✅ Dependência OK |
| v_fornecedores_catalogo      | lens_catalog.lentes           | ✅ Dependência OK |
| v_fornecedores_por_lente     | core.fornecedores             | ✅ Dependência OK |
| v_fornecedores_por_lente     | lens_catalog.lentes           | ✅ Dependência OK |
| v_fornecedores_por_lente     | lens_catalog.marcas           | ✅ Dependência OK |
| v_grupos_canonicos           | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_canonicos_completos | core.fornecedores             | ✅ Dependência OK |
| v_grupos_canonicos_completos | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_canonicos_completos | lens_catalog.lentes           | ✅ Dependência OK |
| v_grupos_melhor_margem       | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_melhor_margem       | lens_catalog.lentes           | ✅ Dependência OK |
| v_grupos_por_faixa_preco     | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_por_faixa_preco     | lens_catalog.lentes           | ✅ Dependência OK |
| v_grupos_por_receita_cliente | core.fornecedores             | ✅ Dependência OK |
| v_grupos_por_receita_cliente | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_por_receita_cliente | lens_catalog.lentes           | ✅ Dependência OK |
| v_grupos_premium             | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_grupos_premium             | lens_catalog.lentes           | ✅ Dependência OK |
| v_grupos_premium             | lens_catalog.marcas           | ✅ Dependência OK |
| v_lentes_busca               | core.fornecedores             | ✅ Dependência OK |
| v_lentes_busca               | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| v_lentes_busca               | lens_catalog.lentes           | ✅ Dependência OK |
| v_lentes_busca               | lens_catalog.marcas           | ✅ Dependência OK |
| v_lentes_cotacao_compra      | core.fornecedores             | ✅ Dependência OK |
| v_lentes_cotacao_compra      | lens_catalog.lentes           | ✅ Dependência OK |
| v_lentes_cotacao_compra      | lens_catalog.marcas           | ✅ Dependência OK |
| v_sugestoes_upgrade          | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| vw_bi_lentes_lucratividade   | lens_catalog.lentes           | ✅ Dependência OK |
| vw_bi_lentes_lucratividade   | lens_catalog.marcas           | ✅ Dependência OK |
| vw_lentes_catalogo           | lens_catalog.lentes           | ✅ Dependência OK |
| vw_lentes_catalogo           | lens_catalog.marcas           | ✅ Dependência OK |
| vw_stats_catalogo            | core.fornecedores             | ✅ Dependência OK |
| vw_stats_catalogo            | lens_catalog.grupos_canonicos | ✅ Dependência OK |
| vw_stats_catalogo            | lens_catalog.lentes           | ✅ Dependência OK |
| vw_stats_catalogo            | lens_catalog.marcas           | ✅ Dependência OK |


-- ============================================================================
-- ETAPA 7: LISTAR TUDO NO PUBLIC PARA ANÁLISE MANUAL
-- ============================================================================
SELECT 
  'VIEW' as tipo,
  table_name as nome,
  NULL as detalhes
FROM information_schema.views
WHERE table_schema = 'public'

UNION ALL

SELECT 
  'FUNCTION' as tipo,
  p.proname as nome,
  pg_get_function_arguments(p.oid) as detalhes
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND p.prokind = 'f'

UNION ALL

SELECT 
  'TABLE' as tipo,
  table_name as nome,
  NULL as detalhes
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_type = 'BASE TABLE'

ORDER BY tipo, nome;


| tipo     | nome                         | detalhes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| -------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| FUNCTION | buscar_lentes                | p_tipo_lente lens_catalog.tipo_lente DEFAULT NULL::lens_catalog.tipo_lente, p_material lens_catalog.material_lente DEFAULT NULL::lens_catalog.material_lente, p_indice lens_catalog.indice_refracao DEFAULT NULL::lens_catalog.indice_refracao, p_preco_min numeric DEFAULT NULL::numeric, p_preco_max numeric DEFAULT NULL::numeric, p_tem_ar boolean DEFAULT NULL::boolean, p_tem_blue boolean DEFAULT NULL::boolean, p_fornecedor_id uuid DEFAULT NULL::uuid, p_marca_id uuid DEFAULT NULL::uuid, p_limit integer DEFAULT 50, p_offset integer DEFAULT 0 |
| FUNCTION | buscar_lentes_por_receita    | p_esferico numeric, p_cilindrico numeric, p_adicao numeric DEFAULT NULL::numeric, p_tipo_lente text DEFAULT NULL::text                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| FUNCTION | obter_alternativas_lente     | p_lente_id uuid, p_limit integer DEFAULT 5                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| FUNCTION | unaccent                     | regdictionary, text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| FUNCTION | unaccent                     | text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| FUNCTION | unaccent_init                | internal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| FUNCTION | unaccent_lexize              | internal, internal, internal, internal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| VIEW     | v_filtros_disponiveis        | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_filtros_grupos_canonicos   | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_fornecedores_catalogo      | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_fornecedores_por_lente     | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_canonicos           | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_canonicos_completos | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_melhor_margem       | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_por_faixa_preco     | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_por_receita_cliente | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_grupos_premium             | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_lentes_busca               | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_lentes_cotacao_compra      | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | v_sugestoes_upgrade          | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | vw_bi_lentes_lucratividade   | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | vw_lentes_catalogo           | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| VIEW     | vw_stats_catalogo            | null                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |



-- ============================================================================
-- ETAPA 8: RESUMO EXECUTIVO
-- ============================================================================
DO $$
DECLARE
  v_total_views INTEGER;
  v_total_functions INTEGER;
  v_total_tables INTEGER;
  v_views_quebradas INTEGER;
BEGIN
  -- Contar totais
  SELECT COUNT(*) INTO v_total_views
  FROM information_schema.views
  WHERE table_schema = 'public';
  
  SELECT COUNT(*) INTO v_total_functions
  FROM pg_proc p
  JOIN pg_namespace n ON p.pronamespace = n.oid
  WHERE n.nspname = 'public' AND p.prokind = 'f';
  
  SELECT COUNT(*) INTO v_total_tables
  FROM information_schema.tables
  WHERE table_schema = 'public' AND table_type = 'BASE TABLE';
  
  -- Tentar identificar views quebradas (aproximado)
  SELECT COUNT(*) INTO v_views_quebradas
  FROM information_schema.views
  WHERE table_schema = 'public'
    AND (
      view_definition ILIKE '%lentes_canonicas%' OR
      view_definition ILIKE '%premium_canonicas%' OR
      view_definition ILIKE '%compras.%'
    );
  
  -- Exibir resumo
  RAISE NOTICE '========================================';
  RAISE NOTICE '📊 RESUMO DO SCHEMA PUBLIC';
  RAISE NOTICE '========================================';
  RAISE NOTICE 'Total de VIEWS: %', v_total_views;
  RAISE NOTICE 'Total de FUNCTIONS: %', v_total_functions;
  RAISE NOTICE 'Total de TABLES: %', v_total_tables;
  RAISE NOTICE '';
  RAISE NOTICE '⚠️ Views potencialmente quebradas: %', v_views_quebradas;
  RAISE NOTICE '';
  RAISE NOTICE '🔍 Execute as ETAPAs 2-6 para detalhes';
  RAISE NOTICE '========================================';
END $$;

Success. No rows returned




-- ============================================================================
-- INSTRUÇÕES
-- ============================================================================
-- 1. Execute este script no Supabase SQL Editor
-- 2. Analise os resultados de cada ETAPA
-- 3. Identifique o que pode ser removido
-- 4. Crie o script 04_LIMPAR_PUBLIC_SCHEMA.sql com os DROPs necessários
-- ============================================================================
